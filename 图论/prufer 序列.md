# prufer 序列
定义 $n$ 个点 $(n\ge 2)$ 的无根树的 prufer 序列 $p$：
- 不断删去编号最小的叶结点，记录与它相连的点编号。
- 删到点数 $= 2$ 时，算法终止。

显然，$p$ 长度为 $n-2$，值域为 $[1,n]$。

> 求证：最后留下的一个点一定有一个是 $n$。  
证明：考虑数学归纳法。 $n=2$ 时，显然成立。  
$\qquad\quad n\ge 2$ 的树至少有两片叶子，因此第一个删除的结点一定不是 $n$。  
$\qquad\quad$ 删去第一个叶结点后剩下的还是一棵树，重复上述过程，最后结点 $n$ 一定会被留下。  

因此，prufer 序列实际上是处理以 $n$ 为根的有根树，  
更准确的说处理的是该有根树的父亲序列 $f$。  
以下均默认 $n$ 为树的根。

## 转换

### 无根树 $\Rightarrow$ prufer 序列
#### $\Theta(n\log n)$ 做法
直接用堆求出编号最小的叶结点删去即可。    
删去后其父亲若变为叶结点则加入堆。  
#### $\Theta(n)$ 做法
- 按编号从小到大扫描各点，扫到叶结点 $u$ 则立即将其删去。
- 删去 $u$ 后立即遍历 $f_u$。若 $f_u$ 变为叶子：
  - 若 $f_u>u$，显然 $f_u$ 会在之后的扫描中被扫到，继续扫描；
  - 若 $f_u<u$，则 $f_u$ 必定为当前编号最小的叶结点，删去 $f_u$ 后继续遍历其父亲，  
    查看其是否为叶子并比较其编号与 $u$ 的大小。
### prufer 序列 $\Rightarrow$ 无根树
#### $\Theta(n\log n)$ 做法
由 $p$ 得到每个**编号**的出现次数，显然未出现在 $p$ 中的**编号**为叶子（包括 $n$）。  

因此过程如下：
- 设除 $n$ 外未确定 $f$ 的不在 $p$ 中的 **编号** 构成集合 $S$。
- 取出 $S$ 中最小值，删去 $p_1$ 作为这个最小值的 $f$，更新 $S$。
- $p$ 删空后 $S$ 剩下一个数，将其 $f$ 置为 $n$。   
 
注意这一过程我们只涉及到**编号**，而没有涉及到具体的图结构。  
#### $\Theta(n)$ 做法
- 将 $p$ 压入队列。
- 按编号从小到大扫描各点，扫到叶结点 $u$ 后弹出队首作为 $f_u$。
- 按 无根树 $\Rightarrow$ prufer 序列 的相同方法删去 $u$ 后考虑 $f_u$，  
    不断弹出队首作为当前结点的父亲。
- 扫描完后，剩余一个点的父亲为空，将它的父亲置为 $n$。

## 凯莱定理 
> 求证：任意长度为 $n-2$，值域为 $[1,n]$ 的序列 $p$ 都可作为 prufer 序列唯一转化为无根树。  
证明：以下默认序列值域为 $[1,n]$。 实际上我们要证明两个部分：    
> - 任意长度为 $n-2$ 的序列都可唯一转化为另一个序列 $f$。  
  任意长度为 $m$ 的序列可唯一确定 $[1,n]$ 在其中的出现次数。  
  由抽屉原理得，长度为 $m$ 的序列至少有 $n-m$ 个数不在其中出现，  
  且可唯一确定哪些数不会出现。  
  若 $m=n-2-k$，则除 $n$ 外至少有 $k+1$ 个数不在其中出现。  
  显然 $k+1$ 是始终大于删去的数目 $k$ 的。  
  因此 $\Theta(n\log n)$ 过程中 $S$ 始终非空，且最后一定会剩下一个数。  
  由此可得一定可以得到 $f$，且 $f$ 是唯一的。
> - $f$ 一定对应一棵以 $n$ 为根的树。  
  不在 $p$ 中的数其 $f$ 一定是一个在 $p$ 中的数，  
  也就不会成环，加上除 $n$ 外每个数都有 $f$，一定会形成一棵树。
>  
>$\qquad$综上，任意长度为 $n-2$，值域为 $[1,n]$ 的序列都可作为 prufer 序列唯一转化为无根树。  



>（凯莱定理）求证：$n$ 个点的带标号无根树个数为 $n^{n-2}$  
证明：$n=1$ 时，显然成立。  
$\qquad n\ge 2$ 时，任意一棵无根树都可唯一转化为其 prufer 序列。   
$\qquad$ 综合前文的证明，$n$ 个点的无根树与长度为 $n-2$，值域为 $[1,n]$ 的序列构成双射。   
$\qquad$ 因此转化为统计 prufer 序列的个数，即 $n^{n-2}$。  

### 推论

- 结点数为 $n$ 的带标号**有根树**个数为 $n^{n-1}$
- 用 $n-1$ 条 **不同的** 无向边连接 $n$ 个不同的点使之连通的方案数为 $(n-1)!n^{n-2}$  
- $n$ 个不同的点，结点 $i$ 度数为 $d_i$ 的无根树个数为 $\displaystyle[\sum_{i=1}^n(d_i-1)=n-2]\dfrac{(n-2)!}{\displaystyle\prod_{i=1}^n(d_i-1)!}$  
  >证明：$d_i-1$ 就是 $i$ 在 prufer 中的出现次数。  
  $\qquad$（对于点 $1\sim n-1$ 就是其儿子数，对于点 $n$ 就是除最后一个点外儿子数）  
  $\qquad$因此度数合法当且仅当可构成 prufer 序列，即 $\displaystyle\sum_{i=1}^n(d_i-1)=n-2$。  
  $\qquad$ 方案数就是合法的 prufer 序列数，即 
  >$$\dbinom{n-2}{d_1-1,d_2-1,\cdots d_n-1}=\dfrac{(n-2)!}{\displaystyle\prod_{i=1}^n(d_i-1)!}$$
- $n$ 个点的带标号无向图有 $k$ 个连通块，设第 $i$ 个连通块的大小为 $s_i$，  
$\qquad$ 则用 $k-1$ 条边将其连通的方案数为 $\displaystyle n^{k-2}\prod_{i=1}^ks_i$。  
  > 证明：考虑拓展 prufer 序列的定义：  
$\qquad$ 每次我们选定的是 **缩点后** 的叶子，但记入序列的是**缩点前**的父亲。  
$\qquad$ 显然，若不考虑儿子及最后一个点父亲缩点前的位置，  
$\qquad$ 连边方案与 prufer 序列构成双射，此时方案有 $n^{k-2}s_k$ 种，  
$\qquad$ $s_k$ 是因为要选定最后一个点的父亲。  
$\qquad$ 接下来除根外每个连通块选定一个结点作为儿子，共有 $\displaystyle\prod_{i=1}^{k-1}s_k$ 种选法。  
$\qquad$因此最终的方案数为 $\displaystyle n^{k-2}\prod_{i=1}^ks_k$